# 简单动态字符串

- `Redis` 没有直接使用 `c语言`的字符串，自己构建一个简单的字符串（simple dynamic string，SDS）的抽象类型。
- 用处：
  1. 保存数据库字符串值
  2. 用作缓冲区：
     - AOF缓冲区（环型缓冲区）
     - 客户端的输入缓冲区

## SDS定义

```c
struct sdshdr {
  // 记录 buf 数组中已使用字节的数量
  // 等于 SDS 所保存字符串的长度
  int len;
  
  // 记录 buf 数组中未使用字节的数量
  int free;
  
  // 字节数组，用于保存字符串
  char buf[];
}；
```

![sdsStruct](https://raw.githubusercontent.com/lyjgulu/redis/main/image/sdsStruct.png)

##  SDS 与 C 字符串的区别

### 获取字符串长度区别

- C 字符串不记录自身长度信息，常数级获取字符串长度。
- SDS 在 len 属性中记录本身的长度，复杂度为 o(1)。

### 杜绝缓冲区溢出

- 由于 C 字符串不记录自身长度信息，容易出现缓冲区溢出。
- SDS 的空间分配策略杜绝了发生缓冲区溢出的可能性，可以自动扩展大小。

### 减少修改字符串时带来的内存重分配次数

- 操作 C 字符串进行增长或者缩短操作，程序都要对保存这个 C 字符串的数组进行一次内存重分配操作。
- SDS 通过未使用空间解除字符串长度和底层数组长度之间的关联，实现空间预分配和惰性空间释放两种优化策略。
  - 空间预分配：len 属性值 * 2 + 1 小于 1MB，多分配 len 属性值空间；大于 1MB，直接分配 1MB。
  - 惰性空间释放：缩短 SDS 保存的字符串，不会收已分配空间而是将这部分空间记录在 free 属性值中以便后面使用。

### 二进制安全

- C 字符串必须符合某种编码格式（比如 ASCII），且除字符串末尾其他位置均不能包含空字符串，只能保存文本。
- SDS API会以处理二进制的方式来处理 SDS 存放在 buf 数组里的数据，可以既保存文本数据，也可以保存任意格式的二进制数据。

### 兼容部分 C 字符

-------

